<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTech PrivacyGuard Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c3e50;
        }
        .container {
            max-width: 960px;
        }
        .section-title {
            border-left: 4px solid #4a90e2;
            padding-left: 1rem;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen p-4">

    <main class="container mx-auto bg-gray-900 text-gray-200 rounded-xl shadow-lg p-8 space-y-8">
        <header class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-white">acta</h1>
            <p class="text-lg text-gray-400">anonimizator de la echipa finguys</p>
        </header>

        <!-- Anonymization Section -->
        <section class="space-y-4">
            <h2 class="text-2xl font-bold text-gray-200 section-title">1. Anonimizează Textul Tău</h2>
            <textarea id="inputText" class="w-full h-48 p-4 bg-gray-700 text-gray-200 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Lipește textul tău financiar aici..." oninput="handleTextChange()"></textarea>

            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="anonymizeButton" onclick="anonymizeText()" class="w-full sm:w-1/3 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105">Anonimizează</button>
                <button id="loadSampleButton" onclick="loadSample()" class="w-full sm:w-1/3 bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 ease-in-out transform hover:scale-105">Încarcă eșantion</button>
            </div>

            <div id="anonymizedOutputContainer" class="hidden mt-6">
                <h3 class="text-xl font-semibold text-gray-200">Text Anonimizat</h3>
                <textarea id="anonymizedTextOutput" class="w-full h-48 p-4 mt-2 bg-gray-700 text-gray-200 rounded-lg border border-gray-600 focus:outline-none" readonly></textarea>
                <button id="copyAnonymizedButton" onclick="copyToClipboard('anonymizedTextOutput')" class="mt-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition duration-300">Copiază Textul Anonimizat</button>
            </div>
        </section>

        <!-- Entities Section -->
        <section id="entitiesSection" class="hidden space-y-4 mt-8">
            <h2 class="text-2xl font-bold text-gray-200 section-title">2. Entități Detectate</h2>
            <div id="entitiesOutput" class="bg-gray-700 p-4 rounded-lg border border-gray-600">
                <p class="text-gray-400">Entitățile vor apărea aici după anonimizare.</p>
            </div>
        </section>

        <!-- AI Analysis Section -->
        <section class="space-y-4 mt-8">
            <h2 class="text-2xl font-bold text-gray-200 section-title">3. Analiză AI</h2>
            <p class="text-gray-400">Obține un rezumat general al textului anonimizat de la o inteligență artificială, fără a compromite confidențialitatea.</p>
            <button id="analyzeButton" onclick="analyzeText()" class="w-full sm:w-auto bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105" disabled>Analizează cu Cohere</button>

            <div id="analysisOutputContainer" class="hidden mt-6">
                <h3 class="text-xl font-semibold text-gray-200">Analiza Cohere</h3>
                <p id="analysisOutput" class="p-4 mt-2 bg-gray-700 text-gray-200 rounded-lg border border-gray-600 whitespace-pre-wrap"></p>
            </div>
        </section>

        <!-- Deanonymization Section -->
        <section class="space-y-4 mt-8">
            <h2 class="text-2xl font-bold text-gray-200 section-title">4. Deanonimizează Textul</h2>
            <p class="text-gray-400">Lipește textul anonimizat mai jos pentru a-l readuce la forma sa originală, sensibilă.</p>
            <textarea id="deanonymizeInput" class="w-full h-48 p-4 bg-gray-700 text-gray-200 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Lipește textul anonimizat aici..."></textarea>
            <button id="deanonymizeButton" onclick="deanonymizeText()" class="w-full sm:w-1/3 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105">Deanonimizează</button>
        </section>
    </main>

    <!-- Modal for Messages -->
    <div id="messageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center space-y-4 border border-gray-700">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-200"></h3>
            <p id="modalMessage" class="text-gray-400"></p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Închide</button>
        </div>
    </div>

    <script>
        let originalText = "";
        let anonymizedEntities = [];
        let isAnonymized = false;

        const inputText = document.getElementById('inputText');
        const anonymizeButton = document.getElementById('anonymizeButton');
        const deanonymizeButton = document.getElementById('deanonymizeButton');
        const analyzeButton = document.getElementById('analyzeButton');
        const anonymizedTextOutput = document.getElementById('anonymizedTextOutput');
        const anonymizedOutputContainer = document.getElementById('anonymizedOutputContainer');
        const entitiesSection = document.getElementById('entitiesSection');
        const entitiesOutput = document.getElementById('entitiesOutput');
        const analysisOutputContainer = document.getElementById('analysisOutputContainer');
        const analysisOutput = document.getElementById('analysisOutput');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const deanonymizeInput = document.getElementById('deanonymizeInput');

        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function closeModal() {
            messageModal.classList.add('hidden');
        }

        function handleTextChange() {
            const currentText = inputText.value;
            if (currentText.length > 0) {
                anonymizeButton.disabled = false;
            } else {
                anonymizeButton.disabled = true;
                analyzeButton.disabled = true;
                anonymizedOutputContainer.classList.add('hidden');
                entitiesSection.classList.add('hidden');
                analysisOutputContainer.classList.add('hidden');
                isAnonymized = false;
            }
        }

        async function anonymizeText() {
            originalText = inputText.value;
            if (!originalText) {
                showModal("Intrare Necesară", "Te rugăm să introduci un text pentru anonimizare.");
                return;
            }

            try {
                const response = await fetch('/api/anonymize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: originalText })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Anonymization failed with status: ${response.status}`);
                }

                const data = await response.json();
                anonymizedTextOutput.value = data.anonymized_text;
                anonymizedEntities = data.entities;

                anonymizedOutputContainer.classList.remove('hidden');
                analyzeButton.disabled = false;
                isAnonymized = true;

                displayEntities(anonymizedEntities);

            } catch (error) {
                showModal("Eroare de Anonimizare", `Anonimizare eșuată: ${error.message}`);
            }
        }

        async function deanonymizeText() {
            const textToDeanonymize = deanonymizeInput.value;
            if (!textToDeanonymize || anonymizedEntities.length === 0) {
                showModal("Operație Invalidă", "Te rugăm să anonimizezi textul mai întâi și să te asiguri că textul de deanonimizat nu este gol.");
                return;
            }

            try {
                const response = await fetch('/api/deanonymize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textToDeanonymize,
                        entities: anonymizedEntities
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Deanonymization failed with status: ${response.status}`);
                }

                const data = await response.json();
                showModal("Text Deanonimizat", data.original_text);

            } catch (error) {
                showModal("Eroare de Deanonimizare", `Deanonimizare eșuată: ${error.message}`);
            }
        }

        async function analyzeText() {
            const textToAnalyze = anonymizedTextOutput.value;
            if (!textToAnalyze || !isAnonymized) {
                showModal("Operație Invalidă", "Te rugăm să anonimizezi textul înainte de analiză.");
                return;
            }

            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Se analizează...';
            analysisOutput.textContent = 'Te rugăm să aștepți în timp ce AI-ul analizează textul...';
            analysisOutputContainer.classList.remove('hidden');

            try {
                const response = await fetch('/api/cohere-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: textToAnalyze,
                        language: 'Romanian'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `Analysis failed with status: ${response.status}`);
                }

                const data = await response.json();
                analysisOutput.textContent = data.analysis;

            } catch (error) {
                analysisOutput.textContent = `Eroare la analiză: ${error.message}`;
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Analizează cu Cohere';
            }
        }

        function loadSample() {
            inputText.value = `Bună, numele meu este Ioana Popescu și numărul meu de telefon este 0722123456. Codul meu personal este 1850101010101 și locuiesc pe strada Principală 1, București. Am un cont cu IBAN RO12ABCD1234567890123456. Adresa mea de email este ioana.popescu@exemplu.com. De asemenea, am un cont de economii cu seria și numărul cărții de identitate AB 1234567.`;
            handleTextChange();
            showModal("Eșantion Încărcat", "Textul eșantion a fost încărcat. Fă clic pe 'Anonimizează' pentru a începe.");
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999);
            document.execCommand("copy");
            showModal("Copiat!", "Textul a fost copiat în clipboard.");
        }

        function displayEntities(entities) {
            entitiesOutput.innerHTML = '';
            if (entities.length === 0) {
                entitiesOutput.innerHTML = '<p class="text-gray-400">Nu au fost detectate entități.</p>';
            } else {
                entities.forEach(entity => {
                    const entityElement = document.createElement('div');
                    entityElement.className = 'bg-blue-600 text-white p-3 rounded-md mb-2';
                    entityElement.innerHTML = `<span class="font-semibold">${entity.entity_type}</span>: <span class="text-gray-100">${entity.original_text}</span>`;
                    entitiesOutput.appendChild(entityElement);
                });
            }
            entitiesSection.classList.remove('hidden');
        }
    </script>
</body>
</html>
